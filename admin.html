<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Administration - SOS Fiche de Paie</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ECRAN DE CONNEXION -->
  <div id="login-section" class="min-h-screen flex items-center justify-center gradient-bg">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
          <i class="fas fa-lock text-blue-600 text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Administration</h1>
        <p class="text-gray-500 mt-1">SOS Fiche de Paie</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
        <input type="password" id="password-input" placeholder="Entrez le mot de passe admin"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
          onkeydown="if(event.key==='Enter') doLogin()">
        <div id="login-error" class="hidden mt-3 text-sm text-red-600 bg-red-50 p-3 rounded-lg">
          <i class="fas fa-exclamation-circle mr-1"></i>
          <span id="login-error-text"></span>
        </div>
        <button onclick="doLogin()" id="login-btn"
          class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
          <i class="fas fa-sign-in-alt"></i> Connexion
        </button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard-section" class="hidden">
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-shield-alt text-xl"></i>
          <span class="font-bold text-lg">SOS Fiche de Paie <span class="font-normal opacity-80">- Admin</span></span>
        </div>
        <button onclick="doLogout()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition text-sm flex items-center gap-2">
          <i class="fas fa-sign-out-alt"></i> Deconnexion
        </button>
      </div>
    </nav>

    <!-- Stats -->
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow p-5 flex items-center gap-4">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-users text-blue-600 text-xl"></i>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total utilisateurs</p>
            <p class="text-2xl font-bold text-gray-800" id="stat-total">-</p>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow p-5 flex items-center gap-4">
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
          </div>
          <div>
            <p class="text-sm text-gray-500">Fichiers disponibles</p>
            <p class="text-2xl font-bold text-gray-800" id="stat-files">-</p>
          </div>
        </div>
      </div>

      <!-- Recherche -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <div class="relative">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-input" placeholder="Rechercher par nom ou email..."
            class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            oninput="filterTable()">
        </div>
      </div>

      <!-- Tableau -->
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Prenom</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Fichier</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Anomalies</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Gain potentiel</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Telecharger</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">JSON</th>
              </tr>
            </thead>
            <tbody id="analyses-tbody" class="divide-y divide-gray-100">
            </tbody>
          </table>
        </div>

        <!-- Etat vide -->
        <div id="empty-state" class="hidden py-12 text-center text-gray-400">
          <i class="fas fa-inbox text-4xl mb-3"></i>
          <p>Aucune analyse trouvee</p>
        </div>

        <!-- Chargement -->
        <div id="loading-state" class="hidden py-12 text-center text-gray-400">
          <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
          <p>Chargement...</p>
        </div>
      </div>

      <!-- Pagination -->
      <div class="mt-4 text-center">
        <button id="load-more-btn" onclick="loadMore()" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition">
          <i class="fas fa-arrow-down mr-2"></i>Charger plus
        </button>
        <p id="total-info" class="mt-2 text-sm text-gray-400"></p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let allAnalyses = [];
    let currentOffset = 0;
    let totalCount = 0;

    function getToken() {
      return sessionStorage.getItem('admin_token');
    }

    // --- LOGIN ---

    async function doLogin() {
      const btn = document.getElementById('login-btn');
      const password = document.getElementById('password-input').value.trim();
      const errorDiv = document.getElementById('login-error');
      const errorText = document.getElementById('login-error-text');

      if (!password) {
        errorDiv.classList.remove('hidden');
        errorText.textContent = 'Veuillez entrer le mot de passe.';
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
      errorDiv.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (!res.ok) {
          errorDiv.classList.remove('hidden');
          errorText.textContent = data.error || 'Erreur de connexion';
          return;
        }

        sessionStorage.setItem('admin_token', data.token);
        showDashboard();
      } catch (err) {
        errorDiv.classList.remove('hidden');
        errorText.textContent = 'Erreur reseau. Reessayez.';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Connexion';
      }
    }

    function doLogout() {
      sessionStorage.removeItem('admin_token');
      allAnalyses = [];
      currentOffset = 0;
      document.getElementById('dashboard-section').classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('password-input').value = '';
    }

    // --- DASHBOARD ---

    function showDashboard() {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard-section').classList.remove('hidden');
      loadAnalyses();
    }

    async function loadAnalyses() {
      const tbody = document.getElementById('analyses-tbody');
      const loading = document.getElementById('loading-state');
      const empty = document.getElementById('empty-state');
      const loadMoreBtn = document.getElementById('load-more-btn');

      if (currentOffset === 0) {
        tbody.innerHTML = '';
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
      }

      try {
        const res = await fetch(`${API_BASE}/analyses?offset=${currentOffset}`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });

        if (res.status === 401) {
          doLogout();
          return;
        }

        const data = await res.json();
        totalCount = data.total;

        allAnalyses = allAnalyses.concat(data.analyses);
        renderTable(allAnalyses);
        updateStats();

        currentOffset += data.analyses.length;

        if (currentOffset < totalCount) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }

        document.getElementById('total-info').textContent =
          `${allAnalyses.length} sur ${totalCount} affichees`;

      } catch (err) {
        console.error('Erreur chargement:', err);
        tbody.innerHTML = `<tr><td colspan="8" class="px-4 py-8 text-center text-red-500">Erreur de chargement</td></tr>`;
      } finally {
        loading.classList.add('hidden');
      }
    }

    function loadMore() {
      loadAnalyses();
    }

    function renderTable(analyses) {
      const tbody = document.getElementById('analyses-tbody');
      const empty = document.getElementById('empty-state');

      if (analyses.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      tbody.innerHTML = analyses.map(a => {
        const date = a.analyzed_at ? new Date(a.analyzed_at).toLocaleDateString('fr-FR', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        }) : '-';

        const gain = a.gain_total_potentiel
          ? `${Math.round(parseFloat(a.gain_total_potentiel))} \u20ac`
          : '-';

        const fileAvailable = a.file_id && !a.deleted_at && a.expires_at && new Date(a.expires_at) > new Date();

        const downloadBtn = fileAvailable
          ? `<button onclick="downloadFile('${a.file_id}', '${escapeHtml(a.file_name || 'fichier')}')" class="inline-flex items-center px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition"><i class="fas fa-download mr-1"></i>Telecharger</button>`
          : a.file_id
            ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-500"><i class="fas fa-clock mr-1"></i>Expire</span>'
            : '<span class="text-gray-300 text-xs">-</span>';

        const fileName = a.file_name
          ? `<span class="text-sm text-gray-600" title="${escapeHtml(a.file_name)}">${truncate(a.file_name, 25)}</span>`
          : '<span class="text-gray-300 text-xs">-</span>';

        return `
          <tr class="hover:bg-gray-50 transition" data-search="${(a.user_prenom || '').toLowerCase()} ${(a.user_email || '').toLowerCase()}">
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${escapeHtml(a.user_prenom || '-')}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(a.user_email || '-')}</td>
            <td class="px-4 py-3">${fileName}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold ${a.nombre_anomalies > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                ${a.nombre_anomalies ?? 0}
              </span>
            </td>
            <td class="px-4 py-3 text-right text-sm font-semibold text-gray-800">${gain}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${date}</td>
            <td class="px-4 py-3 text-center">${downloadBtn}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="downloadAnalysisJson('${a.id}')" class="inline-flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-lg transition"><i class="fas fa-code mr-1"></i>JSON</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      document.getElementById('stat-total').textContent = totalCount;

      const filesAvailable = allAnalyses.filter(a =>
        a.file_id && !a.deleted_at && a.expires_at && new Date(a.expires_at) > new Date()
      ).length;
      document.getElementById('stat-files').textContent = filesAvailable;
    }

    // --- RECHERCHE ---

    function filterTable() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      const rows = document.querySelectorAll('#analyses-tbody tr');
      let visible = 0;

      rows.forEach(row => {
        const searchData = row.getAttribute('data-search') || '';
        const match = !query || searchData.includes(query);
        row.style.display = match ? '' : 'none';
        if (match) visible++;
      });

      const empty = document.getElementById('empty-state');
      empty.classList.toggle('hidden', visible > 0);
    }

    // --- TELECHARGEMENT ---

    async function downloadFile(fileId, fileName) {
      try {
        const res = await fetch(`${API_BASE}/download/${fileId}`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });

        if (res.status === 401) {
          doLogout();
          return;
        }

        if (!res.ok) {
          const err = await res.json();
          alert(err.error || 'Erreur lors du telechargement');
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Erreur telechargement:', err);
        alert('Erreur lors du telechargement du fichier');
      }
    }

    // --- TELECHARGEMENT JSON ---

    function buildAnalysisJson(a) {
      return {
        id: a.id,
        status: a.status,
        periode_bulletin: a.periode_bulletin,
        user_prenom: a.user_prenom,
        user_email: a.user_email,
        nombre_anomalies: a.nombre_anomalies,
        gain_mensuel: a.gain_mensuel,
        gain_annuel: a.gain_annuel,
        gain_total_potentiel: a.gain_total_potentiel,
        anciennete_mois: a.anciennete_mois,
        periode_reclamable_mois: a.periode_reclamable_mois,
        salaire_net_mensuel: a.salaire_net_mensuel,
        pourcentage_salaire_annuel: a.pourcentage_salaire_annuel,
        pourcentage_salaire_total: a.pourcentage_salaire_total,
        prix_rapport: a.prix_rapport,
        anomalies_resume: a.anomalies_resume,
        message_teaser: a.message_teaser,
        raisonnement: a.raw_ocr_text,
        report_sent: a.report_sent,
        analyzed_at: a.analyzed_at
      };
    }

    function downloadAnalysisJson(analysisId) {
      const a = allAnalyses.find(x => x.id === analysisId);
      if (!a) {
        alert('Analyse introuvable');
        return;
      }
      const data = buildAnalysisJson(a);
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `analyse_${(a.user_prenom || 'inconnu').replace(/\s+/g, '_')}_${analysisId}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // --- UTILITAIRES ---

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function truncate(str, max) {
      return str.length > max ? str.substring(0, max) + '...' : str;
    }

    // --- INIT ---

    if (getToken()) {
      showDashboard();
    }
  </script>
</body>
</html>
